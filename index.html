<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>刷题：百分数↔分数 + 平方 + 立方</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Noto Sans CJK SC", "Microsoft YaHei", sans-serif; }
    body { margin: 0; background:#0b1220; color:#e8eefc; }
    .wrap { max-width: 620px; margin: 0 auto; padding: 18px; }
    .card { background:#121b2e; border:1px solid #22304f; border-radius:16px; padding:16px; box-shadow: 0 8px 30px rgba(0,0,0,.25); }
    h1 { font-size: 18px; margin: 0 0 12px; color:#dbe7ff; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > * { flex: 1; }
    label { font-size: 12px; opacity:.9; display:block; margin-bottom:6px; }
    select, input, button {
      width:100%; box-sizing:border-box; border-radius:12px; border:1px solid #2a3a63;
      background:#0f1730; color:#e8eefc; padding:12px 12px; font-size: 16px;
    }
    input::placeholder { color:#94a7d6; }
    button { cursor:pointer; background:#2a5bff; border:none; font-weight:700; }
    button.secondary { background:#1a2442; border:1px solid #2a3a63; font-weight:600; }
    button.danger { background:#b33636; }
    .question {
      font-size: 34px; font-weight:800; letter-spacing:.5px; text-align:center;
      padding: 14px 10px; border-radius: 14px; background:#0f1730; border:1px dashed #2a3a63;
    }
    .hint { font-size: 12px; opacity:.85; margin-top:8px; }
    .msg { margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid #2a3a63; background:#0f1730; }
    .msg.ok { border-color:#2f9e66; }
    .msg.bad { border-color:#ff6b6b; }
    .stats { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .pill { flex:1; min-width:120px; background:#0f1730; border:1px solid #2a3a63; border-radius:12px; padding:10px; }
    .pill b { display:block; font-size:16px; margin-top:4px; }
    .small { font-size:12px; opacity:.85; }
    .divider { height:1px; background:#22304f; margin:14px 0; }
    .list { display:flex; flex-direction:column; gap:8px; }
    .item { padding:10px 12px; border-radius:12px; border:1px solid #2a3a63; background:#0f1730; }
    .item .top { display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .tag { font-size:12px; padding:2px 8px; border-radius:999px; background:#1a2442; border:1px solid #2a3a63; opacity:.95; }
    .footer { margin-top:14px; font-size:12px; opacity:.7; text-align:center; }
    .sym {
      flex: 0 0 auto;
      text-align:center;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #2a3a63;
      background:#0f1730;
      font-weight:800;
      font-size: 22px;
      min-width: 44px;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>刷题：百分数↔分数 + 平方 + 立方</h1>

    <div class="row">
      <div>
        <label>训练</label>
        <select id="training">
          <option value="pctfrac" selected>百分数 ↔ 分数</option>
          <option value="squares">平方数（1–20）</option>
          <option value="cubes">立方数（1–16）</option>
        </select>
      </div>

      <div id="pctfracModeWrap">
        <label>题型</label>
        <select id="modePctFrac">
          <option value="mix" selected>混合（随机50/50）</option>
          <option value="p2f">百分数 → 分数</option>
          <option value="f2p">分数 → 百分数</option>
        </select>
      </div>

      <div id="powerModeWrap" style="display:none;">
        <label>方向</label>
        <select id="modePowers">
          <option value="mix" selected>混合（随机50/50）</option>
          <option value="forward">正向：n → n^k</option>
          <option value="reverse">逆向：n^k → n</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <div id="bankWrap">
        <label>题库</label>
        <select id="bank">
          <option value="fixed" selected>固定：1/(2~23 含0.5)</option>
          <option value="random">随机（分母2~20）</option>
        </select>
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="secondary" id="newBtn">下一题</button>
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="secondary" id="toggleMistakesBtn">错题本</button>
      </div>
    </div>

    <div class="divider"></div>

    <div id="question" class="question">--</div>
    <div class="hint" id="hint">输入区会自动显示 “/” 或 “%”，平方/立方训练只填数字。</div>

    <!-- 百分数↔分数：%→分数：显示 1 / [分母] -->
    <div id="fracWrap" style="display:none; margin-top:10px;">
      <div class="row" style="gap:8px; align-items:center;">
        <div class="sym">1</div>
        <div class="sym">/</div>
        <input id="denOnly" type="number" step="0.5" inputmode="decimal" placeholder="填分母，如 3.5" />
      </div>
      <div class="hint">只填分母：例如填 3.5 表示 1/3.5</div>
    </div>

    <!-- 百分数↔分数：分数→%：显示 [数字] % -->
    <div id="pctWrap" style="display:none; margin-top:10px;">
      <div class="row" style="gap:8px; align-items:center;">
        <input id="pctOnly" type="number" step="0.1" inputmode="decimal" placeholder="填数字，如 33.3" />
        <div class="sym">%</div>
      </div>
      <div class="hint">只填数字：例如填 33.3 表示 33.3%</div>
    </div>

    <!-- 平方/立方训练：只填数字 -->
    <div id="powerWrap" style="display:none; margin-top:10px;">
      <div class="row" style="gap:8px; align-items:center;">
        <input id="powerOnly" type="number" step="1" inputmode="numeric" placeholder="只填数字" />
      </div>
      <div class="hint" id="powerHint">正向：输入 n^k；逆向：输入底数 n</div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="submitBtn">提交</button>
      <button class="secondary" id="revealBtn">显示答案</button>
    </div>

    <div id="msg" class="msg" style="display:none;"></div>

    <div class="stats">
      <div class="pill"><span class="small">正确 / 总题</span><b id="acc">0 / 0</b></div>
      <div class="pill"><span class="small">连对</span><b id="streak">0</b></div>
      <div class="pill"><span class="small">本题用时</span><b id="time">0.0s</b></div>
    </div>

    <div class="divider"></div>

    <div id="mistakesPanel" style="display:none;">
      <div class="row">
        <button class="secondary" id="practiceMistakesBtn">只练错题</button>
        <button class="danger" id="clearMistakesBtn">清空错题</button>
      </div>
      <div class="hint">错题会保存在本机（localStorage）。“只练错题”会从错题里抽题。</div>
      <div class="list" id="mistakesList" style="margin-top:10px;"></div>
    </div>

    <div class="footer">手机浏览器菜单 → “添加到主屏幕” 可像App一样使用。</div>
  </div>
</div>

<script>
/** ---------- DOM ---------- **/
const el = (id) => document.getElementById(id);

/** ---------- 分数工具 ---------- **/
function gcd(a, b) {
  a = Math.abs(a); b = Math.abs(b);
  while (b !== 0) { const t = a % b; a = b; b = t; }
  return a || 1;
}
function simplifyFrac(n, d) {
  if (!Number.isFinite(n) || !Number.isFinite(d) || d === 0) return null;
  if (d < 0) { n = -n; d = -d; }
  const nn = Math.trunc(n);
  const dd = Math.trunc(d);
  const g = gcd(nn, dd);
  return { n: nn / g, d: dd / g, g };
}
function fracToString(fr) { return fr.d === 1 ? String(fr.n) : `${fr.n}/${fr.d}`; }
function fracEqual(a, b) { return a.n === b.n && a.d === b.d; }

function toRational(x) {
  const s = String(x).trim();
  if (s.includes("e") || s.includes("E")) {
    const denom = 1000000000;
    return simplifyFrac(Math.round(Number(s) * denom), denom);
  }
  if (!s.includes(".")) return simplifyFrac(Number(s), 1);
  const k = s.length - s.indexOf(".") - 1;
  const scale = 10 ** k;
  const n = Math.round(Number(s) * scale);
  const d = scale;
  return simplifyFrac(n, d);
}
function parseFraction(str) {
  const s = str.trim();
  if (!s) return null;
  if (s.includes("/")) {
    const parts = s.split("/");
    if (parts.length !== 2) return null;
    const a = Number(parts[0].trim());
    const b = Number(parts[1].trim());
    if (!Number.isFinite(a) || !Number.isFinite(b) || b === 0) return null;
    const ra = toRational(a);
    const rb = toRational(b);
    if (!ra || !rb || rb.n === 0) return null;
    const n = ra.n * rb.d;
    const d = ra.d * rb.n;
    return simplifyFrac(n, d);
  } else {
    const a = Number(s);
    if (!Number.isFinite(a)) return null;
    const ra = toRational(a);
    return simplifyFrac(ra.n, ra.d);
  }
}
function parsePercent(str) {
  let s = str.trim();
  if (!s) return null;
  if (s.endsWith("%")) s = s.slice(0, -1).trim();
  const v = Number(s);
  if (!Number.isFinite(v)) return null;
  return v;
}
function percentToFrac(p) {
  const s = String(p);
  let n, d;
  if (s.includes("e") || s.includes("E")) {
    const v = p / 100;
    const denom = 1000000000;
    n = Math.round(v * denom);
    d = denom;
  } else if (s.includes(".")) {
    const k = s.length - s.indexOf(".") - 1;
    const scale = 10 ** k;
    n = Math.round(p * scale);
    d = 100 * scale;
  } else {
    n = Math.round(p);
    d = 100;
  }
  return simplifyFrac(n, d);
}
function fracToPercent(fr) { return (fr.n / fr.d) * 100; }

/** ---------- 百分数↔分数：固定题库 ---------- **/
const DENOMS = [
  2, 2.5, 3, 3.5, 4, 4.5, 5, 5.5, 6, 6.5, 7, 7.5, 8, 8.5, 9, 9.5,
  10, 10.5, 11, 11.5, 12, 12.5, 13, 13.5, 14, 14.5, 15, 15.5, 16, 16.5,
  17, 17.5, 18, 18.5, 19, 19.5, 20, 21, 22, 23
];
function fmtPercentFromDenom(d) {
  const p = 100 / d;
  const r = Math.round(p * 10) / 10;
  return (Math.abs(r - Math.round(r)) < 1e-9) ? `${Math.round(r)}%` : `${r}%`;
}
function fracDisplayFromDenom(d) { return `1/${d}`; }

const FIXED_BANK = (() => {
  const list = [];
  for (const d of DENOMS) {
    const fDisp = fracDisplayFromDenom(d);
    const pDisp = fmtPercentFromDenom(d);
    const pVal = parseFloat(pDisp.replace("%",""));

    const dRat = toRational(d);
    const exactFrac = simplifyFrac(dRat.d, dRat.n);

    list.push({ kind:"pctfrac", type:"f2p", display: fDisp, frac: { n: 1, d: d }, ansP: pDisp });
    list.push({ kind:"pctfrac", type:"p2f", display: pDisp, p: pVal, ansFrac: exactFrac, displayFrac: fDisp });
  }
  return list;
})();

/** ---------- 百分数↔分数：随机（可选） ---------- **/
function randInt(a, b) { return Math.floor(Math.random() * (b - a + 1)) + a; }
function choice(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

function genRandomFracQuestion() {
  const d = randInt(2, 20);
  const n = randInt(1, d - 1);
  const fr = simplifyFrac(n, d);
  return { kind:"pctfrac", type:"f2p", display:`${fr.n}/${fr.d}`, frac:fr, ansP:null };
}
function genRandomPercentQuestion() {
  const d = choice([2,4,5,8,10,20,25,40]);
  const n = randInt(1, d - 1);
  const fr = simplifyFrac(n, d);
  const p = fracToPercent(fr);
  const r = Math.round(p * 10) / 10;
  const disp = (Math.abs(r - Math.round(r)) < 1e-9) ? `${Math.round(r)}%` : `${r}%`;
  return { kind:"pctfrac", type:"p2f", display:disp, p:r, ansFrac:null, displayFrac:null };
}

/** ---------- 平方 / 立方 题库 ---------- **/
const SQUARES = Array.from({length:20}, (_,i)=>{ const n=i+1; return {n, val:n*n}; });
const CUBES   = Array.from({length:16}, (_,i)=>{ const n=i+1; return {n, val:n*n*n}; });

function pickPowerQuestion(kind, mode) {
  const arr = (kind === "squares") ? SQUARES : CUBES;
  const k = (kind === "squares") ? 2 : 3;
  const item = choice(arr);

  let dir = mode;
  if (mode === "mix") dir = (Math.random() < 0.5 ? "forward" : "reverse");

  if (dir === "forward") {
    return { kind, dir:"forward", k, prompt:`${item.n}`, answer:String(item.val) };
  } else {
    return { kind, dir:"reverse", k, prompt:`${item.val}`, answer:String(item.n) };
  }
}

/** ---------- 错题本 ---------- **/
const LS_KEY = "trainer_mistakes_v2";
function loadMistakes() {
  try { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }
  catch { return []; }
}
function saveMistakes(list) { localStorage.setItem(LS_KEY, JSON.stringify(list)); }
function mistakeKey(q) {
  if (q.kind === "pctfrac") return `pctfrac|${q.type}|${q.display}`;
  return `${q.kind}|${q.dir}|${q.prompt}`;
}
function addMistake(q) {
  const list = loadMistakes();
  const key = mistakeKey(q);
  if (!list.some(x => mistakeKey(x) === key)) {
    list.unshift(q);
    saveMistakes(list.slice(0, 500));
  }
}

/** ---------- 出题 ---------- **/
function pickPctFracQuestion({ mode, bank }) {
  const needType = mode === "mix" ? null : mode;
  if (bank === "fixed") {
    const candidates = FIXED_BANK;
    const t = needType || (Math.random() < 0.5 ? "p2f" : "f2p");
    return choice(candidates.filter(x => x.type === t));
  } else {
    if (needType === "p2f") return genRandomPercentQuestion();
    if (needType === "f2p") return genRandomFracQuestion();
    return (Math.random() < 0.5) ? genRandomPercentQuestion() : genRandomFracQuestion();
  }
}

function pickFromMistakes(kind, mode) {
  const mistakes = loadMistakes();
  const ms = mistakes.filter(x => x.kind === kind);
  if (!ms.length) return null;

  if (kind === "pctfrac") {
    const needType = mode === "mix" ? null : mode;
    if (!needType) {
      const t = Math.random() < 0.5 ? "p2f" : "f2p";
      const pool = ms.filter(x => x.type === t);
      return pool.length ? choice(pool) : choice(ms);
    } else {
      const pool = ms.filter(x => x.type === needType);
      return pool.length ? choice(pool) : choice(ms);
    }
  } else {
    let dir = mode;
    if (mode === "mix") dir = (Math.random() < 0.5 ? "forward" : "reverse");
    const pool = ms.filter(x => x.dir === dir);
    return pool.length ? choice(pool) : choice(ms);
  }
}

function pickQuestion() {
  const training = el("training").value;
  const practiceMistakes = state.practiceMistakes;

  if (training === "pctfrac") {
    const mode = el("modePctFrac").value;
    const bank = el("bank").value;
    if (practiceMistakes) {
      const q = pickFromMistakes("pctfrac", mode);
      if (q) return q;
    }
    return pickPctFracQuestion({ mode, bank });
  }

  // squares / cubes
  const mode = el("modePowers").value;
  if (practiceMistakes) {
    const q = pickFromMistakes(training, mode);
    if (q) return q;
  }
  return pickPowerQuestion(training, mode);
}

/** ---------- UI/状态 ---------- **/
const questionEl = el("question");
const msgEl = el("msg"), accEl = el("acc"), streakEl = el("streak"), timeEl = el("time");
const mistakesPanel = el("mistakesPanel"), mistakesList = el("mistakesList");

const fracWrap = el("fracWrap"), pctWrap = el("pctWrap"), powerWrap = el("powerWrap");
const denOnly = el("denOnly"), pctOnly = el("pctOnly"), powerOnly = el("powerOnly");

let state = {
  q: null,
  total: 0,
  correct: 0,
  streak: 0,
  startAt: performance.now(),
  practiceMistakes: false,
};

function showMsg(text, ok=null) {
  msgEl.style.display = "block";
  msgEl.textContent = text;
  msgEl.classList.remove("ok", "bad");
  if (ok === true) msgEl.classList.add("ok");
  if (ok === false) msgEl.classList.add("bad");
}
function clearMsg() { msgEl.style.display = "none"; msgEl.textContent = ""; }
function updateStats(dtSec=0) {
  accEl.textContent = `${state.correct} / ${state.total}`;
  streakEl.textContent = `${state.streak}`;
  timeEl.textContent = `${dtSec.toFixed(1)}s`;
}

function renderMistakes() {
  const list = loadMistakes();
  mistakesList.innerHTML = "";
  if (!list.length) {
    const div = document.createElement("div");
    div.className = "item";
    div.textContent = "暂无错题。";
    mistakesList.appendChild(div);
    return;
  }
  for (const m of list.slice(0, 140)) {
    const div = document.createElement("div");
    div.className = "item";
    const top = document.createElement("div");
    top.className = "top";

    let tagText, prompt, ans;
    if (m.kind === "pctfrac") {
      tagText = (m.type === "p2f" ? "%→分数" : "分数→%");
      prompt = m.display;
      ans = (m.type === "p2f") ? (m.displayFrac || fracToString(m.ansFrac)) : m.ansP;
    } else if (m.kind === "squares") {
      tagText = (m.dir === "forward" ? "平方：正向" : "平方：逆向");
      prompt = m.prompt;
      ans = m.answer;
    } else {
      tagText = (m.dir === "forward" ? "立方：正向" : "立方：逆向");
      prompt = m.prompt;
      ans = m.answer;
    }

    const left = document.createElement("div");
    left.innerHTML = `<b>${prompt}</b> <span class="tag">${tagText}</span>`;

    const right = document.createElement("div");
    right.className = "small";
    right.textContent = `答案：${ans}`;

    top.appendChild(left);
    top.appendChild(right);
    div.appendChild(top);
    mistakesList.appendChild(div);
  }
}

function syncUIByTraining() {
  const training = el("training").value;
  el("pctfracModeWrap").style.display = (training === "pctfrac") ? "block" : "none";
  el("powerModeWrap").style.display   = (training !== "pctfrac") ? "block" : "none";
  el("bankWrap").style.display        = (training === "pctfrac") ? "block" : "none";
}

function setInputModeForQuestion(q) {
  denOnly.value = ""; pctOnly.value = ""; powerOnly.value = "";

  if (q.kind === "pctfrac") {
    powerWrap.style.display = "none";
    if (q.type === "p2f") {
      fracWrap.style.display = "block";
      pctWrap.style.display = "none";
      denOnly.focus();
      el("hint").textContent = "本题：百分数 → 分数。界面已显示 “1/”，你只需要填分母。";
    } else {
      fracWrap.style.display = "none";
      pctWrap.style.display = "block";
      pctOnly.focus();
      el("hint").textContent = "本题：分数 → 百分数。界面已显示 “%”，你只需要填数字。";
    }
  } else {
    fracWrap.style.display = "none";
    pctWrap.style.display = "none";
    powerWrap.style.display = "block";
    powerOnly.focus();
    const name = (q.kind === "squares") ? "平方" : "立方";
    const exp = (q.kind === "squares") ? "²" : "³";
    el("powerHint").textContent = (q.dir === "forward")
      ? `${name}正向：题目给 n，请输入 n${exp}（只填数字）`
      : `${name}逆向：题目给 n${exp}，请输入底数 n（只填数字）`;
    el("hint").textContent = (q.dir === "forward")
      ? `${name}训练（正向）：只填结果数字`
      : `${name}训练（逆向）：只填底数数字`;
  }
}

function newQuestion() {
  clearMsg();
  syncUIByTraining();

  state.q = pickQuestion();
  questionEl.textContent = (state.q.kind === "pctfrac") ? state.q.display : state.q.prompt;

  state.startAt = performance.now();
  setInputModeForQuestion(state.q);
  updateStats(0);
}

function revealAnswer() {
  const q = state.q;
  if (!q) return;
  if (q.kind === "pctfrac") {
    showMsg(`答案：${q.type === "p2f" ? (q.displayFrac || fracToString(q.ansFrac)) : q.ansP}`, null);
  } else {
    showMsg(`答案：${q.answer}`, null);
  }
}

function submit() {
  const q = state.q;
  if (!q) return;
  const dtSec = (performance.now() - state.startAt) / 1000;

  let userRaw = "";
  if (q.kind === "pctfrac") {
    if (q.type === "p2f") {
      const den = denOnly.value.trim();
      if (!den) { showMsg("请填写分母（如 3.5）。", false); return; }
      userRaw = `1/${den}`;
    } else {
      const pct = pctOnly.value.trim();
      if (!pct) { showMsg("请输入百分数数字（如 33.3）。", false); return; }
      userRaw = pct;
    }
  } else {
    const v = powerOnly.value.trim();
    if (!v) { showMsg("只需要输入数字答案。", false); return; }
    userRaw = v;
  }

  state.total += 1;

  if (q.kind === "pctfrac") {
    if (q.type === "p2f") {
      const user = parseFraction(userRaw);
      if (!user) { state.total -= 1; showMsg("分母格式不对：请只输入数字（如 3 或 3.5）。", false); return; }
      const correct = simplifyFrac(q.ansFrac.n, q.ansFrac.d);
      const ok = fracEqual(user, correct);
      if (ok) { state.correct += 1; state.streak += 1; showMsg(`✅ 正确！用时 ${dtSec.toFixed(1)}s`, true); }
      else { state.streak = 0; showMsg(`❌ 错误。正确答案：${q.displayFrac || fracToString(correct)}`, false); addMistake(q); }
    } else {
      const userP = parsePercent(userRaw);
      if (userP === null) { state.total -= 1; showMsg("请输入数字（如 33.3），不用写 %。", false); return; }
      const correctP = parsePercent(q.ansP);
      const ok = Math.abs(userP - correctP) < 1e-9;
      if (ok) { state.correct += 1; state.streak += 1; showMsg(`✅ 正确！用时 ${dtSec.toFixed(1)}s`, true); }
      else { state.streak = 0; showMsg(`❌ 错误。正确答案：${q.ansP}`, false); addMistake(q); }
    }
  } else {
    const user = String(parseInt(userRaw, 10));
    if (user === "NaN") { state.total -= 1; showMsg("只需要输入整数数字。", false); return; }
    const ok = (user === q.answer);
    if (ok) { state.correct += 1; state.streak += 1; showMsg(`✅ 正确！用时 ${dtSec.toFixed(1)}s`, true); }
    else { state.streak = 0; showMsg(`❌ 错误。正确答案：${q.answer}`, false); addMistake(q); }
  }

  updateStats(dtSec);
}

/** ---------- 事件 ---------- **/
el("newBtn").addEventListener("click", newQuestion);
el("submitBtn").addEventListener("click", submit);
el("revealBtn").addEventListener("click", revealAnswer);

denOnly.addEventListener("keydown", (e) => { if (e.key === "Enter") submit(); });
pctOnly.addEventListener("keydown", (e) => { if (e.key === "Enter") submit(); });
powerOnly.addEventListener("keydown", (e) => { if (e.key === "Enter") submit(); });

el("training").addEventListener("change", () => {
  state.practiceMistakes = false;
  newQuestion();
});

el("toggleMistakesBtn").addEventListener("click", () => {
  const show = mistakesPanel.style.display === "none";
  mistakesPanel.style.display = show ? "block" : "none";
  if (show) renderMistakes();
});

el("practiceMistakesBtn").addEventListener("click", () => {
  const list = loadMistakes();
  if (!list.length) { showMsg("错题本为空。先做几题再来～", false); return; }
  state.practiceMistakes = !state.practiceMistakes;
  showMsg(state.practiceMistakes ? "已切换：只练错题" : "已切换：正常出题", null);
  newQuestion();
});

el("clearMistakesBtn").addEventListener("click", () => {
  if (confirm("确定清空错题本吗？")) {
    saveMistakes([]);
    renderMistakes();
    showMsg("已清空错题本。", null);
  }
});

// 初始
syncUIByTraining();
newQuestion();
</script>
</body>
</html>
