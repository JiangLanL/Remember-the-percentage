<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>百分数↔分数 速练</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Noto Sans CJK SC", "Microsoft YaHei", sans-serif; }
    body { margin: 0; background:#0b1220; color:#e8eefc; }
    .wrap { max-width: 560px; margin: 0 auto; padding: 18px; }
    .card { background:#121b2e; border:1px solid #22304f; border-radius:16px; padding:16px; box-shadow: 0 8px 30px rgba(0,0,0,.25); }
    h1 { font-size: 18px; margin: 0 0 12px; color:#dbe7ff; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > * { flex: 1; }
    label { font-size: 12px; opacity:.9; display:block; margin-bottom:6px; }
    select, input, button {
      width:100%; box-sizing:border-box; border-radius:12px; border:1px solid #2a3a63;
      background:#0f1730; color:#e8eefc; padding:12px 12px; font-size: 16px;
    }
    input::placeholder { color:#94a7d6; }
    button { cursor:pointer; background:#2a5bff; border:none; font-weight:700; }
    button.secondary { background:#1a2442; border:1px solid #2a3a63; font-weight:600; }
    button.danger { background:#b33636; }
    .question {
      font-size: 34px; font-weight:800; letter-spacing:.5px; text-align:center;
      padding: 14px 10px; border-radius: 14px; background:#0f1730; border:1px dashed #2a3a63;
    }
    .hint { font-size: 12px; opacity:.85; margin-top:8px; }
    .msg { margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid #2a3a63; background:#0f1730; }
    .msg.ok { border-color:#2f9e66; }
    .msg.bad { border-color:#ff6b6b; }
    .stats { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .pill { flex:1; min-width:120px; background:#0f1730; border:1px solid #2a3a63; border-radius:12px; padding:10px; }
    .pill b { display:block; font-size:16px; margin-top:4px; }
    .small { font-size:12px; opacity:.85; }
    .divider { height:1px; background:#22304f; margin:14px 0; }
    .list { display:flex; flex-direction:column; gap:8px; }
    .item { padding:10px 12px; border-radius:12px; border:1px solid #2a3a63; background:#0f1730; }
    .item .top { display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .tag { font-size:12px; padding:2px 8px; border-radius:999px; background:#1a2442; border:1px solid #2a3a63; opacity:.95; }
    .footer { margin-top:14px; font-size:12px; opacity:.7; text-align:center; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>百分数 ↔ 分数 速练（网页版）</h1>

    <div class="row">
      <div>
        <label>题型</label>
        <select id="mode">
          <option value="mix" selected>混合（随机50/50）</option>
          <option value="p2f">百分数 → 分数</option>
          <option value="f2p">分数 → 百分数</option>
        </select>
      </div>
      <div>
        <label>题库</label>
        <select id="bank">
          <option value="fixed" selected>固定：1/(2~23 含0.5)</option>
          <option value="random">随机（分母2~20）</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="secondary" id="newBtn">下一题</button>
      <button class="secondary" id="toggleMistakesBtn">错题本</button>
    </div>

    <div class="divider"></div>

    <div id="question" class="question">--</div>
    <div class="hint" id="hint">输入格式：分数用 a/b（如 1/8 或 1/2.5），百分数用 12.5% 或 12.5</div>

    <div class="row" style="margin-top:10px;">
      <input id="answer" placeholder="在这里输入答案…" autocomplete="off" inputmode="decimal" />
    </div>
    <div class="row" style="margin-top:10px;">
      <button id="submitBtn">提交</button>
      <button class="secondary" id="revealBtn">显示答案</button>
    </div>

    <div id="msg" class="msg" style="display:none;"></div>

    <div class="stats">
      <div class="pill"><span class="small">正确 / 总题</span><b id="acc">0 / 0</b></div>
      <div class="pill"><span class="small">连对</span><b id="streak">0</b></div>
      <div class="pill"><span class="small">本题用时</span><b id="time">0.0s</b></div>
    </div>

    <div class="divider"></div>

    <div id="mistakesPanel" style="display:none;">
      <div class="row">
        <button class="secondary" id="practiceMistakesBtn">只练错题</button>
        <button class="danger" id="clearMistakesBtn">清空错题</button>
      </div>
      <div class="hint">错题会保存在本机（localStorage）。点击“只练错题”会从错题里抽题。</div>
      <div class="list" id="mistakesList" style="margin-top:10px;"></div>
    </div>

    <div class="footer">手机浏览器菜单 → “添加到主屏幕” 可像App一样使用。</div>
  </div>
</div>

<script>
/** ---------- 基础数学 ---------- **/
function gcd(a, b) {
  a = Math.abs(a); b = Math.abs(b);
  while (b !== 0) { const t = a % b; a = b; b = t; }
  return a || 1;
}
function simplifyFrac(n, d) {
  if (!Number.isFinite(n) || !Number.isFinite(d) || d === 0) return null;
  if (d < 0) { n = -n; d = -d; }
  const g = gcd(Math.trunc(n), Math.trunc(d));
  return { n: Math.trunc(n) / g, d: Math.trunc(d) / g, g };
}
function fracToString(fr) {
  return fr.d === 1 ? String(fr.n) : `${fr.n}/${fr.d}`;
}
function fracEqual(a, b) {
  return a.n === b.n && a.d === b.d;
}

/** ---------- 解析：支持小数分母 1/2.5 ---------- **/
function toRational(x) {
  const s = String(x).trim();
  if (s.includes("e") || s.includes("E")) {
    const denom = 1000000000;
    return simplifyFrac(Math.round(Number(s) * denom), denom);
  }
  if (!s.includes(".")) return simplifyFrac(Number(s), 1);

  const k = s.length - s.indexOf(".") - 1;
  const scale = 10 ** k;
  const n = Math.round(Number(s) * scale);
  const d = scale;
  return simplifyFrac(n, d);
}

function parseFraction(str) {
  // 支持 "a/b" 或 "a"，且 a、b 可为小数
  const s = str.trim();
  if (!s) return null;

  if (s.includes("/")) {
    const parts = s.split("/");
    if (parts.length !== 2) return null;

    const a = Number(parts[0].trim());
    const b = Number(parts[1].trim());
    if (!Number.isFinite(a) || !Number.isFinite(b) || b === 0) return null;

    const ra = toRational(a); // a = ra.n/ra.d
    const rb = toRational(b); // b = rb.n/rb.d
    if (!ra || !rb || rb.n === 0) return null;

    // (ra.n/ra.d) / (rb.n/rb.d) = ra.n*rb.d / (ra.d*rb.n)
    const n = ra.n * rb.d;
    const d = ra.d * rb.n;
    return simplifyFrac(n, d);
  } else {
    const a = Number(s);
    if (!Number.isFinite(a)) return null;
    const ra = toRational(a);
    return simplifyFrac(ra.n, ra.d);
  }
}

function parsePercent(str) {
  let s = str.trim();
  if (!s) return null;
  if (s.endsWith("%")) s = s.slice(0, -1).trim();
  const v = Number(s);
  if (!Number.isFinite(v)) return null;
  return v; // 数值：12.5 表示 12.5%
}

/** ---------- 百分数<->分数 ---------- **/
function percentToFrac(p) {
  // p% = p/100，支持小数
  const s = String(p);
  let n, d;
  if (s.includes("e") || s.includes("E")) {
    const v = p / 100;
    const denom = 1000000000;
    n = Math.round(v * denom);
    d = denom;
  } else if (s.includes(".")) {
    const k = s.length - s.indexOf(".") - 1;
    const scale = 10 ** k;
    n = Math.round(p * scale);
    d = 100 * scale;
  } else {
    n = Math.round(p);
    d = 100;
  }
  return simplifyFrac(n, d);
}
function fracToPercent(fr) {
  return (fr.n / fr.d) * 100;
}

/** ---------- 题库：你指定的固定列表 1/(2~23含0.5) ---------- **/
const DENOMS = [
  2, 2.5, 3, 3.5, 4, 4.5, 5, 5.5, 6, 6.5, 7, 7.5, 8, 8.5, 9, 9.5,
  10, 10.5, 11, 11.5, 12, 12.5, 13, 13.5, 14, 14.5, 15, 15.5, 16, 16.5,
  17, 17.5, 18, 18.5, 19, 19.5, 20, 21, 22, 23
];

function fmtPercentFromDenom(d) {
  const p = 100 / d;
  const r = Math.round(p * 10) / 10; // 1位小数
  return (Math.abs(r - Math.round(r)) < 1e-9) ? `${Math.round(r)}%` : `${r}%`;
}
function fracDisplayFromDenom(d) {
  return `1/${d}`; // 按你的显示习惯保留小数分母
}

const FIXED_BANK = (() => {
  const list = [];

  for (const d of DENOMS) {
    const fDisp = fracDisplayFromDenom(d);   // "1/2.5"
    const pDisp = fmtPercentFromDenom(d);    // "40%" 或 "33.3%"
    const pVal = parseFloat(pDisp.replace("%","")); // 用显示值作为数值（避免浮点长尾）

    // 用“分母转有理数”精确算出 1/d
    const dRat = toRational(d);              // d = dRat.n / dRat.d
    const exactFrac = simplifyFrac(dRat.d, dRat.n); // 1/d = dRat.d / dRat.n

    // 分数 -> 百分数
    list.push({
      type: "f2p",
      display: fDisp,
      frac: { n: 1, d: d },     // 允许小数分母，判题会转有理数
      ansP: pDisp
    });

    // 百分数 -> 分数（关键：答案直接用 exactFrac，不再从 pVal 反推）
    list.push({
      type: "p2f",
      display: pDisp,
      p: pVal,                  // 只用于展示/容错，不用于生成答案
      ansFrac: exactFrac,        // ✅ 精确答案
      displayFrac: fDisp
    });
  }

  return list;
})();

/** ---------- 随机题库（可选） ---------- **/
function randInt(a, b) { return Math.floor(Math.random() * (b - a + 1)) + a; }
function choice(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

function genRandomFracQuestion() {
  const d = randInt(2, 20);
  const n = randInt(1, d - 1);
  const fr = simplifyFrac(n, d);
  return { type:"f2p", display:`${fr.n}/${fr.d}`, frac:fr, ansP:null };
}
function genRandomPercentQuestion() {
  // 通过随机分数生成百分数（尽量好化）
  const d = choice([2,4,5,8,10,20,25,40]);
  const n = randInt(1, d - 1);
  const fr = simplifyFrac(n, d);
  const p = fracToPercent(fr);
  const r = Math.round(p * 10) / 10;
  const disp = (Math.abs(r - Math.round(r)) < 1e-9) ? `${Math.round(r)}%` : `${r}%`;
  return { type:"p2f", display:disp, p:r, ansFrac:null };
}

/** ---------- 错题本 ---------- **/
const LS_KEY = "pct_frac_mistakes_v2";
function loadMistakes() {
  try { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }
  catch { return []; }
}
function saveMistakes(list) {
  localStorage.setItem(LS_KEY, JSON.stringify(list));
}
function mistakeKey(q) { return `${q.type}|${q.display}`; }
function addMistake(q) {
  const list = loadMistakes();
  const key = mistakeKey(q);
  if (!list.some(x => mistakeKey(x) === key)) {
    list.unshift({
      type: q.type,
      display: q.display,
      p: q.p ?? null,
      frac: q.frac ?? null,
      ansFrac: q.ansFrac ?? null,
      ansP: q.ansP ?? null,
      displayFrac: q.displayFrac ?? null
    });
    saveMistakes(list.slice(0, 300));
  }
}

/** ---------- 出题：混合随机50/50 ---------- **/
function pickQuestion({ mode, bank, fromMistakes=false, mistakes=[] }) {
  let q = null;
  const needType = mode === "mix" ? null : mode;

  if (fromMistakes && mistakes.length) {
    // 错题本：也支持混合（仍然 50/50 尝试挑题型）
    if (!needType) {
      const t = Math.random() < 0.5 ? "p2f" : "f2p";
      const pool = mistakes.filter(x => x.type === t);
      q = pool.length ? choice(pool) : choice(mistakes);
    } else {
      const pool = mistakes.filter(x => x.type === needType);
      q = pool.length ? choice(pool) : choice(mistakes);
    }
  } else {
    if (bank === "fixed") {
      const candidates = FIXED_BANK;
      let pool;
      if (needType) {
        pool = candidates.filter(x => x.type === needType);
      } else {
        const t = Math.random() < 0.5 ? "p2f" : "f2p";
        pool = candidates.filter(x => x.type === t);
      }
      q = choice(pool);
    } else {
      // random
      if (needType === "p2f") q = genRandomPercentQuestion();
      else if (needType === "f2p") q = genRandomFracQuestion();
      else q = (Math.random() < 0.5) ? genRandomPercentQuestion() : genRandomFracQuestion();
    }
  }

  // 补齐标准答案
  if (q.type === "p2f" && !q.ansFrac) q.ansFrac = percentToFrac(q.p);
  if (q.type === "f2p" && !q.ansP) {
    const p = fracToPercent(q.frac);
    const r = Math.round(p * 10) / 10;
    q.ansP = (Math.abs(r - Math.round(r)) < 1e-9) ? `${Math.round(r)}%` : `${r}%`;
  }

  return q;
}

/** ---------- UI 状态 ---------- **/
const el = (id) => document.getElementById(id);
const modeEl = el("mode"), bankEl = el("bank");
const questionEl = el("question"), answerEl = el("answer");
const msgEl = el("msg"), accEl = el("acc"), streakEl = el("streak"), timeEl = el("time");
const mistakesPanel = el("mistakesPanel"), mistakesList = el("mistakesList");

let state = {
  q: null,
  total: 0,
  correct: 0,
  streak: 0,
  startAt: performance.now(),
  practiceMistakes: false,
};

function showMsg(text, ok=null) {
  msgEl.style.display = "block";
  msgEl.textContent = text;
  msgEl.classList.remove("ok", "bad");
  if (ok === true) msgEl.classList.add("ok");
  if (ok === false) msgEl.classList.add("bad");
}
function clearMsg() { msgEl.style.display = "none"; msgEl.textContent = ""; }

function updateStats(dtSec=0) {
  accEl.textContent = `${state.correct} / ${state.total}`;
  streakEl.textContent = `${state.streak}`;
  timeEl.textContent = `${dtSec.toFixed(1)}s`;
}

function renderMistakes() {
  const list = loadMistakes();
  mistakesList.innerHTML = "";
  if (!list.length) {
    const div = document.createElement("div");
    div.className = "item";
    div.textContent = "暂无错题。";
    mistakesList.appendChild(div);
    return;
  }
  for (const m of list.slice(0, 80)) {
    const div = document.createElement("div");
    div.className = "item";
    const top = document.createElement("div");
    top.className = "top";

    const left = document.createElement("div");
    left.innerHTML = `<b>${m.display}</b> <span class="tag">${m.type==="p2f"?"%→分数":"分数→%"}</span>`;

    const right = document.createElement("div");
    right.className = "small";
    right.textContent = (m.type==="p2f")
      ? `答案：${m.displayFrac || fracToString(m.ansFrac)}`
      : `答案：${m.ansP}`;

    top.appendChild(left);
    top.appendChild(right);
    div.appendChild(top);
    mistakesList.appendChild(div);
  }
}

function newQuestion() {
  clearMsg();
  answerEl.value = "";
  answerEl.focus();

  const mode = modeEl.value;
  const bank = bankEl.value;
  const mistakes = loadMistakes();

  state.q = pickQuestion({
    mode,
    bank,
    fromMistakes: state.practiceMistakes,
    mistakes
  });

  questionEl.textContent = state.q.display;
  state.startAt = performance.now();

  if (state.q.type === "p2f") el("hint").textContent = "输入分数：a/b（如 1/8 或 1/2.5）。会按“最简分数”判定通过。";
  else el("hint").textContent = "输入百分数：如 12.5% 或 12.5（默认保留 1 位小数的答案）。";

  updateStats(0);
}

function revealAnswer() {
  const q = state.q;
  if (!q) return;
  if (q.type === "p2f") showMsg(`答案：${q.displayFrac || fracToString(q.ansFrac)}`, null);
  else showMsg(`答案：${q.ansP}`, null);
}

function submit() {
  const q = state.q;
  if (!q) return;

  const dtSec = (performance.now() - state.startAt) / 1000;
  const raw = answerEl.value.trim();
  if (!raw) {
    showMsg("请先输入答案。", false);
    return;
  }

  state.total += 1;

  if (q.type === "p2f") {
    const user = parseFraction(raw);
    if (!user) {
      state.total -= 1; // 不算题
      showMsg("分数格式不对：请用 a/b（如 1/8 或 1/2.5）或整数。", false);
      return;
    }

    const correct = simplifyFrac(q.ansFrac.n, q.ansFrac.d);

    // 等值判断
    const eq = fracEqual(user, correct);

    // 最简分数判断：只有当用户确实输入了“整数分子/整数分母”时才严格要求最简
    // 如果用户用了小数（如 1/2.5），我们仍按等值通过（否则体验很别扭）
    let requireSimplest = true;
    let isSimplest = true;

    if (raw.includes("/")) {
      const parts = raw.split("/");
      const aStr = parts[0].trim(), bStr = parts[1].trim();
      const aIsInt = /^[+-]?\d+$/.test(aStr);
      const bIsInt = /^[+-]?\d+$/.test(bStr);
      if (aIsInt && bIsInt) {
        const a0 = Number(aStr), b0 = Number(bStr);
        isSimplest = (gcd(a0, b0) === 1);
      } else {
        // 含小数分母/分子时，不强制“最简”规则（否则 1/2.5 永远不可能是最简）
        requireSimplest = false;
      }
    }

    if (eq && (!requireSimplest || isSimplest)) {
      state.correct += 1;
      state.streak += 1;
      showMsg(`✅ 正确！用时 ${dtSec.toFixed(1)}s`, true);
    } else if (eq && requireSimplest && !isSimplest) {
      state.streak = 0;
      showMsg(`⚠️ 等值但不是最简分数。最简为：${fracToString(correct)}（本题按未通过处理）`, false);
      addMistake(q);
    } else {
      state.streak = 0;
      showMsg(`❌ 错误。正确答案：${q.displayFrac || fracToString(correct)}`, false);
      addMistake(q);
    }

  } else { // f2p
    const userP = parsePercent(raw);
    if (userP === null) {
      state.total -= 1; // 不算题
      showMsg("百分数格式不对：如 12.5% 或 12.5。", false);
      return;
    }

    const correctP = parsePercent(q.ansP);
    const ok = Math.abs(userP - correctP) < 1e-9;

    if (ok) {
      state.correct += 1;
      state.streak += 1;
      showMsg(`✅ 正确！用时 ${dtSec.toFixed(1)}s`, true);
    } else {
      state.streak = 0;
      showMsg(`❌ 错误。正确答案：${q.ansP}`, false);
      addMistake(q);
    }
  }

  updateStats(dtSec);
}

/** ---------- 事件绑定 ---------- **/
el("newBtn").addEventListener("click", newQuestion);
el("submitBtn").addEventListener("click", submit);
el("revealBtn").addEventListener("click", revealAnswer);

answerEl.addEventListener("keydown", (e) => {
  if (e.key === "Enter") submit();
});

el("toggleMistakesBtn").addEventListener("click", () => {
  const show = mistakesPanel.style.display === "none";
  mistakesPanel.style.display = show ? "block" : "none";
  if (show) renderMistakes();
});

el("practiceMistakesBtn").addEventListener("click", () => {
  const list = loadMistakes();
  if (!list.length) {
    showMsg("错题本为空。先做几题再来～", false);
    return;
  }
  state.practiceMistakes = !state.practiceMistakes;
  showMsg(state.practiceMistakes ? "已切换：只练错题" : "已切换：正常出题", null);
  newQuestion();
});

el("clearMistakesBtn").addEventListener("click", () => {
  if (confirm("确定清空错题本吗？")) {
    saveMistakes([]);
    renderMistakes();
    showMsg("已清空错题本。", null);
  }
});

// 初始出题
newQuestion();
</script>
</body>
</html>
