<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>百分数↔分数 速练</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, "PingFang SC", "Noto Sans CJK SC", "Microsoft YaHei", sans-serif; }
    body { margin: 0; background:#0b1220; color:#e8eefc; }
    .wrap { max-width: 560px; margin: 0 auto; padding: 18px; }
    .card { background:#121b2e; border:1px solid #22304f; border-radius:16px; padding:16px; box-shadow: 0 8px 30px rgba(0,0,0,.25); }
    h1 { font-size: 18px; margin: 0 0 12px; color:#dbe7ff; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > * { flex: 1; }
    label { font-size: 12px; opacity:.9; display:block; margin-bottom:6px; }
    select, input, button {
      width:100%; box-sizing:border-box; border-radius:12px; border:1px solid #2a3a63;
      background:#0f1730; color:#e8eefc; padding:12px 12px; font-size: 16px;
    }
    input::placeholder { color:#94a7d6; }
    button { cursor:pointer; background:#2a5bff; border:none; font-weight:700; }
    button.secondary { background:#1a2442; border:1px solid #2a3a63; font-weight:600; }
    button.danger { background:#b33636; }
    .question {
      font-size: 34px; font-weight:800; letter-spacing:.5px; text-align:center;
      padding: 14px 10px; border-radius: 14px; background:#0f1730; border:1px dashed #2a3a63;
    }
    .hint { font-size: 12px; opacity:.85; margin-top:8px; }
    .msg { margin-top:10px; padding:10px 12px; border-radius:12px; border:1px solid #2a3a63; background:#0f1730; }
    .msg.ok { border-color:#2f9e66; }
    .msg.bad { border-color:#ff6b6b; }
    .stats { display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    .pill { flex:1; min-width:120px; background:#0f1730; border:1px solid #2a3a63; border-radius:12px; padding:10px; }
    .pill b { display:block; font-size:16px; margin-top:4px; }
    .small { font-size:12px; opacity:.85; }
    .divider { height:1px; background:#22304f; margin:14px 0; }
    .list { display:flex; flex-direction:column; gap:8px; }
    .item { padding:10px 12px; border-radius:12px; border:1px solid #2a3a63; background:#0f1730; }
    .item .top { display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; }
    .tag { font-size:12px; padding:2px 8px; border-radius:999px; background:#1a2442; border:1px solid #2a3a63; opacity:.95; }
    .footer { margin-top:14px; font-size:12px; opacity:.7; text-align:center; }

    /* 小号“符号块” */
    .sym {
      flex: 0 0 auto;
      text-align:center;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid #2a3a63;
      background:#0f1730;
      font-weight:800;
      font-size: 22px;
      min-width: 44px;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>百分数 ↔ 分数 速练（网页版）</h1>

    <div class="row">
      <div>
        <label>题型</label>
        <select id="mode">
          <option value="mix" selected>混合（随机50/50）</option>
          <option value="p2f">百分数 → 分数</option>
          <option value="f2p">分数 → 百分数</option>
        </select>
      </div>
      <div>
        <label>题库</label>
        <select id="bank">
          <option value="fixed" selected>固定：1/(2~23 含0.5)</option>
          <option value="random">随机（分母2~20）</option>
        </select>
      </div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button class="secondary" id="newBtn">下一题</button>
      <button class="secondary" id="toggleMistakesBtn">错题本</button>
    </div>

    <div class="divider"></div>

    <div id="question" class="question">--</div>
    <div class="hint" id="hint">输入区会自动显示 “/” 或 “%”，你只需要填数字。</div>

    <!-- 分数输入：显示 1 / [分母]（用于 百分数→分数） -->
    <div id="fracWrap" style="display:none; margin-top:10px;">
      <div class="row" style="gap:8px; align-items:center;">
        <div class="sym">1</div>
        <div class="sym">/</div>
        <input id="denOnly" type="number" step="0.5" inputmode="decimal" placeholder="填分母，如 3.5" />
      </div>
      <div class="hint">只填分母：例如填 3.5 表示 1/3.5</div>
    </div>

    <!-- 百分数输入：显示 [数字] %（用于 分数→百分数） -->
    <div id="pctWrap" style="display:none; margin-top:10px;">
      <div class="row" style="gap:8px; align-items:center;">
        <input id="pctOnly" type="number" step="0.1" inputmode="decimal" placeholder="填数字，如 33.3" />
        <div class="sym">%</div>
      </div>
      <div class="hint">只填数字：例如填 33.3 表示 33.3%</div>
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="submitBtn">提交</button>
      <button class="secondary" id="revealBtn">显示答案</button>
    </div>

    <div id="msg" class="msg" style="display:none;"></div>

    <div class="stats">
      <div class="pill"><span class="small">正确 / 总题</span><b id="acc">0 / 0</b></div>
      <div class="pill"><span class="small">连对</span><b id="streak">0</b></div>
      <div class="pill"><span class="small">本题用时</span><b id="time">0.0s</b></div>
    </div>

    <div class="divider"></div>

    <div id="mistakesPanel" style="display:none;">
      <div class="row">
        <button class="secondary" id="practiceMistakesBtn">只练错题</button>
        <button class="danger" id="clearMistakesBtn">清空错题</button>
      </div>
      <div class="hint">错题会保存在本机（localStorage）。点击“只练错题”会从错题里抽题。</div>
      <div class="list" id="mistakesList" style="margin-top:10px;"></div>
    </div>

    <div class="footer">手机浏览器菜单 → “添加到主屏幕” 可像App一样使用。</div>
  </div>
</div>

<script>
/** ---------- 工具：DOM ---------- **/
const el = (id) => document.getElementById(id);

/** ---------- 基础数学（整数分数） ---------- **/
function gcd(a, b) {
  a = Math.abs(a); b = Math.abs(b);
  while (b !== 0) { const t = a % b; a = b; b = t; }
  return a || 1;
}
function simplifyFrac(n, d) {
  if (!Number.isFinite(n) || !Number.isFinite(d) || d === 0) return null;
  if (d < 0) { n = -n; d = -d; }
  const nn = Math.trunc(n);
  const dd = Math.trunc(d);
  const g = gcd(nn, dd);
  return { n: nn / g, d: dd / g, g };
}
function fracToString(fr) {
  return fr.d === 1 ? String(fr.n) : `${fr.n}/${fr.d}`;
}
function fracEqual(a, b) {
  return a.n === b.n && a.d === b.d;
}

/** ---------- 小数转有理数（精确表示有限小数） ---------- **/
function toRational(x) {
  const s = String(x).trim();
  if (s.includes("e") || s.includes("E")) {
    const denom = 1000000000;
    return simplifyFrac(Math.round(Number(s) * denom), denom);
  }
  if (!s.includes(".")) return simplifyFrac(Number(s), 1);

  const k = s.length - s.indexOf(".") - 1;
  const scale = 10 ** k;
  const n = Math.round(Number(s) * scale);
  const d = scale;
  return simplifyFrac(n, d);
}

/** ---------- 解析：支持 1/2.5 等形式 ---------- **/
function parseFraction(str) {
  const s = str.trim();
  if (!s) return null;

  if (s.includes("/")) {
    const parts = s.split("/");
    if (parts.length !== 2) return null;

    const a = Number(parts[0].trim());
    const b = Number(parts[1].trim());
    if (!Number.isFinite(a) || !Number.isFinite(b) || b === 0) return null;

    const ra = toRational(a);
    const rb = toRational(b);
    if (!ra || !rb || rb.n === 0) return null;

    // (ra.n/ra.d) / (rb.n/rb.d) = ra.n*rb.d / (ra.d*rb.n)
    const n = ra.n * rb.d;
    const d = ra.d * rb.n;
    return simplifyFrac(n, d);
  } else {
    const a = Number(s);
    if (!Number.isFinite(a)) return null;
    const ra = toRational(a);
    return simplifyFrac(ra.n, ra.d);
  }
}

function parsePercent(str) {
  let s = str.trim();
  if (!s) return null;
  if (s.endsWith("%")) s = s.slice(0, -1).trim();
  const v = Number(s);
  if (!Number.isFinite(v)) return null;
  return v; // 12.5 表示 12.5%
}

/** ---------- 转换 ---------- **/
function percentToFrac(p) {
  // p% = p/100（用于随机题库的反推，固定题库不用这个生成答案）
  const s = String(p);
  let n, d;
  if (s.includes("e") || s.includes("E")) {
    const v = p / 100;
    const denom = 1000000000;
    n = Math.round(v * denom);
    d = denom;
  } else if (s.includes(".")) {
    const k = s.length - s.indexOf(".") - 1;
    const scale = 10 ** k;
    n = Math.round(p * scale);
    d = 100 * scale;
  } else {
    n = Math.round(p);
    d = 100;
  }
  return simplifyFrac(n, d);
}
function fracToPercent(fr) {
  return (fr.n / fr.d) * 100;
}

/** ---------- 固定题库：1/(2~23 含0.5) ---------- **/
const DENOMS = [
  2, 2.5, 3, 3.5, 4, 4.5, 5, 5.5, 6, 6.5, 7, 7.5, 8, 8.5, 9, 9.5,
  10, 10.5, 11, 11.5, 12, 12.5, 13, 13.5, 14, 14.5, 15, 15.5, 16, 16.5,
  17, 17.5, 18, 18.5, 19, 19.5, 20, 21, 22, 23
];

function fmtPercentFromDenom(d) {
  const p = 100 / d;
  const r = Math.round(p * 10) / 10; // 1 位小数
  return (Math.abs(r - Math.round(r)) < 1e-9) ? `${Math.round(r)}%` : `${r}%`;
}
function fracDisplayFromDenom(d) {
  return `1/${d}`; // 按你的记忆方式显示（保留 2.5、3.5）
}

const FIXED_BANK = (() => {
  const list = [];
  for (const d of DENOMS) {
    const fDisp = fracDisplayFromDenom(d);   // "1/2.5"
    const pDisp = fmtPercentFromDenom(d);    // "40%" 或 "33.3%"
    const pVal = parseFloat(pDisp.replace("%","")); // 用展示值作为数值（避免 33.333333333... 长尾）

    // 精确答案：1/d（把 d 先转有理数，再取倒数）
    const dRat = toRational(d);              // d = dRat.n / dRat.d
    const exactFrac = simplifyFrac(dRat.d, dRat.n); // 1/d = dRat.d / dRat.n

    // 分数 -> 百分数
    list.push({
      type: "f2p",
      display: fDisp,
      frac: { n: 1, d: d },    // 小数分母允许，判题时转有理数
      ansP: pDisp
    });

    // 百分数 -> 分数
    list.push({
      type: "p2f",
      display: pDisp,
      p: pVal,                 // 只用于展示/容错
      ansFrac: exactFrac,       // ✅ 精确答案（不再由百分数反推）
      displayFrac: fDisp
    });
  }
  return list;
})();

/** ---------- 随机题库（可选） ---------- **/
function randInt(a, b) { return Math.floor(Math.random() * (b - a + 1)) + a; }
function choice(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

function genRandomFracQuestion() {
  const d = randInt(2, 20);
  const n = randInt(1, d - 1);
  const fr = simplifyFrac(n, d);
  return { type:"f2p", display:`${fr.n}/${fr.d}`, frac:fr, ansP:null };
}
function genRandomPercentQuestion() {
  const d = choice([2,4,5,8,10,20,25,40]);
  const n = randInt(1, d - 1);
  const fr = simplifyFrac(n, d);
  const p = fracToPercent(fr);
  const r = Math.round(p * 10) / 10;
  const disp = (Math.abs(r - Math.round(r)) < 1e-9) ? `${Math.round(r)}%` : `${r}%`;
  return { type:"p2f", display:disp, p:r, ansFrac:null, displayFrac:null };
}

/** ---------- 错题本 ---------- **/
const LS_KEY = "pct_frac_mistakes_v3";
function loadMistakes() {
  try { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }
  catch { return []; }
}
function saveMistakes(list) {
  localStorage.setItem(LS_KEY, JSON.stringify(list));
}
function mistakeKey(q) { return `${q.type}|${q.display}`; }
function addMistake(q) {
  const list = loadMistakes();
  const key = mistakeKey(q);
  if (!list.some(x => mistakeKey(x) === key)) {
    list.unshift({
      type: q.type,
      display: q.display,
      p: q.p ?? null,
      frac: q.frac ?? null,
      ansFrac: q.ansFrac ?? null,
      ansP: q.ansP ?? null,
      displayFrac: q.displayFrac ?? null
    });
    saveMistakes(list.slice(0, 300));
  }
}

/** ---------- 出题：混合随机50/50 ---------- **/
function pickQuestion({ mode, bank, fromMistakes=false, mistakes=[] }) {
  let q = null;
  const needType = mode === "mix" ? null : mode;

  if (fromMistakes && mistakes.length) {
    if (!needType) {
      const t = Math.random() < 0.5 ? "p2f" : "f2p";
      const pool = mistakes.filter(x => x.type === t);
      q = pool.length ? choice(pool) : choice(mistakes);
    } else {
      const pool = mistakes.filter(x => x.type === needType);
      q = pool.length ? choice(pool) : choice(mistakes);
    }
  } else {
    if (bank === "fixed") {
      const candidates = FIXED_BANK;
      let pool;
      if (needType) pool = candidates.filter(x => x.type === needType);
      else {
        const t = Math.random() < 0.5 ? "p2f" : "f2p";
        pool = candidates.filter(x => x.type === t);
      }
      q = choice(pool);
    } else {
      // random
      if (needType === "p2f") q = genRandomPercentQuestion();
      else if (needType === "f2p") q = genRandomFracQuestion();
      else q = (Math.random() < 0.5) ? genRandomPercentQuestion() : genRandomFracQuestion();
    }
  }

  // 补齐标准答案（主要给 random 用）
  if (q.type === "p2f" && !q.ansFrac) q.ansFrac = percentToFrac(q.p);
  if (q.type === "f2p" && !q.ansP) {
    const p = fracToPercent(q.frac);
    const r = Math.round(p * 10) / 10;
    q.ansP = (Math.abs(r - Math.round(r)) < 1e-9) ? `${Math.round(r)}%` : `${r}%`;
  }
  return q;
}

/** ---------- UI 状态 ---------- **/
const modeEl = el("mode"), bankEl = el("bank");
const questionEl = el("question");
const msgEl = el("msg"), accEl = el("acc"), streakEl = el("streak"), timeEl = el("time");
const mistakesPanel = el("mistakesPanel"), mistakesList = el("mistakesList");

const fracWrap = el("fracWrap");
const pctWrap  = el("pctWrap");
const denOnly  = el("denOnly");
const pctOnly  = el("pctOnly");

let state = {
  q: null,
  total: 0,
  correct: 0,
  streak: 0,
  startAt: performance.now(),
  practiceMistakes: false,
};

function showMsg(text, ok=null) {
  msgEl.style.display = "block";
  msgEl.textContent = text;
  msgEl.classList.remove("ok", "bad");
  if (ok === true) msgEl.classList.add("ok");
  if (ok === false) msgEl.classList.add("bad");
}
function clearMsg() { msgEl.style.display = "none"; msgEl.textContent = ""; }

function updateStats(dtSec=0) {
  accEl.textContent = `${state.correct} / ${state.total}`;
  streakEl.textContent = `${state.streak}`;
  timeEl.textContent = `${dtSec.toFixed(1)}s`;
}

function renderMistakes() {
  const list = loadMistakes();
  mistakesList.innerHTML = "";
  if (!list.length) {
    const div = document.createElement("div");
    div.className = "item";
    div.textContent = "暂无错题。";
    mistakesList.appendChild(div);
    return;
  }
  for (const m of list.slice(0, 80)) {
    const div = document.createElement("div");
    div.className = "item";
    const top = document.createElement("div");
    top.className = "top";

    const left = document.createElement("div");
    left.innerHTML = `<b>${m.display}</b> <span class="tag">${m.type==="p2f"?"%→分数":"分数→%"}</span>`;

    const right = document.createElement("div");
    right.className = "small";
    right.textContent = (m.type==="p2f")
      ? `答案：${m.displayFrac || fracToString(m.ansFrac)}`
      : `答案：${m.ansP}`;

    top.appendChild(left);
    top.appendChild(right);
    div.appendChild(top);
    mistakesList.appendChild(div);
  }
}

function setInputModeForQuestion(q) {
  denOnly.value = "";
  pctOnly.value = "";

  if (q.type === "p2f") {
    // % -> 分数：只填分母
    fracWrap.style.display = "block";
    pctWrap.style.display = "none";
    denOnly.focus();
  } else {
    // 分数 -> %：只填数字
    fracWrap.style.display = "none";
    pctWrap.style.display = "block";
    pctOnly.focus();
  }
}

function newQuestion() {
  clearMsg();

  const mode = modeEl.value;
  const bank = bankEl.value;
  const mistakes = loadMistakes();

  state.q = pickQuestion({
    mode,
    bank,
    fromMistakes: state.practiceMistakes,
    mistakes
  });

  questionEl.textContent = state.q.display;
  state.startAt = performance.now();
  setInputModeForQuestion(state.q);

  el("hint").textContent = (state.q.type === "p2f")
    ? "本题：百分数 → 分数。界面已显示 “1/”，你只需要填分母。"
    : "本题：分数 → 百分数。界面已显示 “%”，你只需要填数字。";

  updateStats(0);
}

function revealAnswer() {
  const q = state.q;
  if (!q) return;
  if (q.type === "p2f") showMsg(`答案：${q.displayFrac || fracToString(q.ansFrac)}`, null);
  else showMsg(`答案：${q.ansP}`, null);
}

function submit() {
  const q = state.q;
  if (!q) return;

  const dtSec = (performance.now() - state.startAt) / 1000;

  // 读取用户输入（只读数字）
  let raw = "";
  if (q.type === "p2f") {
    const den = denOnly.value.trim();
    if (!den) { showMsg("请填写分母（如 3.5）。", false); return; }
    raw = `1/${den}`; // 拼成分数给 parseFraction
  } else {
    const pct = pctOnly.value.trim();
    if (!pct) { showMsg("请输入百分数数字（如 33.3）。", false); return; }
    raw = pct; // 不需要 %
  }

  state.total += 1;

  if (q.type === "p2f") {
    const user = parseFraction(raw);
    if (!user) {
      state.total -= 1;
      showMsg("分母格式不对：请只输入数字（如 3 或 3.5）。", false);
      return;
    }

    const correct = simplifyFrac(q.ansFrac.n, q.ansFrac.d);
    const eq = fracEqual(user, correct);

    // 你现在只填分母，不需要“最简分数”规则，等值即算对
    if (eq) {
      state.correct += 1;
      state.streak += 1;
      showMsg(`✅ 正确！用时 ${dtSec.toFixed(1)}s`, true);
    } else {
      state.streak = 0;
      showMsg(`❌ 错误。正确答案：${q.displayFrac || fracToString(correct)}`, false);
      addMistake(q);
    }

  } else { // f2p
    const userP = parsePercent(raw);
    if (userP === null) {
      state.total -= 1;
      showMsg("请输入数字（如 33.3），不用写 %。", false);
      return;
    }
    const correctP = parsePercent(q.ansP);
    const ok = Math.abs(userP - correctP) < 1e-9;

    if (ok) {
      state.correct += 1;
      state.streak += 1;
      showMsg(`✅ 正确！用时 ${dtSec.toFixed(1)}s`, true);
    } else {
      state.streak = 0;
      showMsg(`❌ 错误。正确答案：${q.ansP}`, false);
      addMistake(q);
    }
  }

  updateStats(dtSec);
}

/** ---------- 事件绑定 ---------- **/
el("newBtn").addEventListener("click", newQuestion);
el("submitBtn").addEventListener("click", submit);
el("revealBtn").addEventListener("click", revealAnswer);

// 让手机键盘“完成/回车”也能提交
denOnly.addEventListener("keydown", (e) => { if (e.key === "Enter") submit(); });
pctOnly.addEventListener("keydown", (e) => { if (e.key === "Enter") submit(); });

el("toggleMistakesBtn").addEventListener("click", () => {
  const show = mistakesPanel.style.display === "none";
  mistakesPanel.style.display = show ? "block" : "none";
  if (show) renderMistakes();
});

el("practiceMistakesBtn").addEventListener("click", () => {
  const list = loadMistakes();
  if (!list.length) {
    showMsg("错题本为空。先做几题再来～", false);
    return;
  }
  state.practiceMistakes = !state.practiceMistakes;
  showMsg(state.practiceMistakes ? "已切换：只练错题" : "已切换：正常出题", null);
  newQuestion();
});

el("clearMistakesBtn").addEventListener("click", () => {
  if (confirm("确定清空错题本吗？")) {
    saveMistakes([]);
    renderMistakes();
    showMsg("已清空错题本。", null);
  }
});

// 初始出题
newQuestion();
</script>
</body>
</html>
